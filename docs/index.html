<script>
(async () => {
  const owner = "Tasnemo";
  const repo  = "Stuy-Computational-Physics";
  const branch = "main";     // change if your default branch is different
  const root   = "docs/";    // only list HTMLs under docs/

  const host  = document.getElementById('content');
  const empty = document.getElementById('empty');
  const qIn   = document.getElementById('q');

  // 1) Get a recursive tree of the whole branch in ONE request
  const treeURL = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
  let tree;
  try {
    const r = await fetch(treeURL, {headers:{'Accept':'application/vnd.github+json'}});
    if (!r.ok) throw new Error(`GitHub API ${r.status}`);
    const data = await r.json();
    tree = data.tree || [];
  } catch (e) {
    host.innerHTML = `<div class="empty">Couldnâ€™t read repo tree (${e.message}). If rate-limited, refresh later.</div>`;
    return;
  }

  // 2) Keep only docs/**/*.html (exclude index.html)
  const items = tree
    .filter(t => t.type === 'blob' && t.path.startsWith(root) && t.path.toLowerCase().endsWith('.html'))
    .filter(t => t.path.toLowerCase() !== root + 'index.html')
    .map(t => {
      const rel = t.path.slice(root.length);     // path under docs/
      const href = './' + rel;                   // link from Pages site
      const slash = rel.indexOf('/');
      const group = slash === -1 ? '(root)' : rel.slice(0, slash); // first folder
      const name  = rel.split('/').pop();
      return { group, rel, href, name };
    })
    .sort((a,b) => (a.group.localeCompare(b.group)) || a.rel.localeCompare(b.rel));

  function render() {
    const q = (qIn?.value || '').trim().toLowerCase();
    const filtered = items.filter(it => {
      const hay = `${it.name} ${it.rel} ${it.group}`.toLowerCase();
      return q ? hay.includes(q) : true;
    });

    if (!filtered.length) {
      host.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    // group by folder
    const groups = {};
    for (const it of filtered) (groups[it.group] ||= []).push(it);

    host.innerHTML = Object.keys(groups).sort().map(g => {
      const cards = groups[g].map(it => `
        <div class="card">
          <a href="${it.href}">${it.name.replace(/_/g,' ')}</a>
          <div class="path">${it.rel}</div>
        </div>`).join('');
      return `<div class="section"><h2>${g}</h2><div class="grid">${cards}</div><div class="divider"></div></div>`;
    }).join('');
  }

  if (qIn) qIn.addEventListener('input', render);
  render();
})();
</script>
